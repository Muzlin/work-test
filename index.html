<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>注册</title>
  <link rel="stylesheet" href="./css/main.css">
  <link rel="stylesheet" href="./js/xwPop/css/xwPop.css">
  <link rel="stylesheet" href="./js/cxValidation/css/cxvalidation.css">
  <script src="./js/fastclick.js"></script>
  <script src="./js/jquery.min.js"></script>
  <script src="./js/xwPop/js/xwPop.js"></script>
  <script src="./js/zepto.min.js"></script>
  <script src="./js/cxValidation/js/cxvalidation.js"></script>
</head>
<body>
<form action="" id="regForm">
  <main>
    <div class="container active">
      <div class="header"><img src="./img/banner.png" alt=""></div>
      <div class="form">
        <ul>
          <li>
            <div class="form-item">
              <lable>手机号码</lable>
              <input type="text" placeholder="请输入您的手机号码" data-validation="required,onlyNumber,minSize[11],maxSize[11]"
                     data-validation-message="手机号码不正确" id="phone">
            </div>
          </li>
          <li>
            <div class="form-item">
              <lable>登录密码</lable>
              <input type="password" placeholder="请输入您的登录密码" data-validation="required"
                     data-validation-message="登录密码不能为空" id="password"></div>
          </li>
          <li>
            <div class="form-item codeInput">
              <div>
                <lable>短信验证码</lable>
                <input type="text" placeholder="请输入短信验证码" data-validation="required,onlyNumber,minSize[6],maxSize[6]"
                       data-validation-message="请输入6位短信验证码" id="checkCode"></div>
              <div>
                <button class="codeButton" onclick="sendCode($(this))">发送验证码
                </button>
              </div>
            </div>
          </li>
          <li class="hint">
            <div>
              <span>充值、提现等资金操作前均须认证开户：</span>
            </div>
          </li>
          <li>
            <div class="form-item">
              <lable>持卡人</lable>
              <input type="text" placeholder="填写您的真实姓名" data-validation="required" data-validation-message="真实姓名不能为空"
                     id="realName"></div>
          </li>
          <li>
            <div class="form-item">
              <lable>身份证号码</lable>
              <input type="text" placeholder="大陆有效居民身份证" data-validation="required"
                     data-validation-message="身份证号码不正确" id="idCode"></div>
          </li>
          <li>
            <div class="form-item">
              <lable>选择银行</lable>
              <div class="checkInput" id="checkBank">
                <input type="text" readonly placeholder="请选择" data-validation-message="请选择银行"
                       id="bankValue">
                <img src="./img/icon-arrow-right.png" alt="">
              </div>
            </div>
          </li>
          <li>
            <div class="form-item">
              <lable>银行卡号</lable>
              <input type="text" placeholder="填写储蓄卡号" data-validation="required,onlyNumber,maxSize[30]"
                     data-validation-message="银行卡号不正确" id="bankNo"></div>
          </li>
          <li>
            <div class="form-item">
              <lable>开户省份</lable>
              <div class="checkInput" id="checkProvince">
                <input type="text" readonly placeholder="请选择"
                       data-validation-message="请选择开户省份" id="provinceValue">
                <img src="./img/icon-arrow-right.png" alt="">
              </div>
            </div>
          </li>
          <li>
            <div class="form-item">
              <lable>开户城市</lable>
              <div class="checkInput" id="checkCity">
                <input type="text" readonly placeholder="请选择"
                       data-validation-message="请选择开户城市" id="cityValue">
                <img src="./img/icon-arrow-right.png" alt="">
              </div>
            </div>
          </li>
          <li class="hint">
            <div>
              <h4></h4>
            </div>
          </li>
          <li>
            <div class="form-item">
              <lable>存管银行提现支付密码</lable>
              <input type="password" placeholder="请设置6位数字交易密码"
                     data-validation="required,onlyNumber,maxSize[6],minSize[6]" data-validation-message="请设置6位数字交易密码"
                     id="cgPwd"></div>
          </li>
          <li>
            <div class="form-item">
              <lable>确认密码</lable>
              <input type="password" placeholder="请确认交易密码" data-validation="equals[cgPwd]"
                     data-validation-message="两次存管密码不正确" id="ccgPwd"></div>
          </li>
        </ul>
      </div>
      <div class="selection rule" id="checkBox">
        <input type="checkbox" id="agree-checkbox">
        <label class="agree-box active" for="agree-checkbox"></label>
        <span>点击"立即确认"即表示您已同意 <a href="https://m.139lc.com/views/dl/protocol/hzgProtocol.html">《和掌柜平台服务协议》</a>
        <a href="https://m.139lc.com/views/wd/fyyhc/netLoan.html">《网贷客户交易结算资金账户三方协议》</a><a
              href="https://m.139lc.com/views/wd/fyyhc/userAuthorization.html">《用户授权协议》</a></span>
      </div>
      <div class="selection submit">
        <input type="submit" value="立即确认">
      </div>
      <div class="selection description">
        <div>
          <img src="./img/icon-safe.png" alt="">
          <span>和掌柜三年稳健运行</span>
        </div>
      </div>
    </div>
    <div class="boxList bankBox">
      <ul>
        <li>暂未读取到数据</li>
      </ul>
    </div>
    <div class="boxList provinceBox">
      <ul>
        <li>暂未读取到数据</li>
      </ul>
    </div>
    <div class="boxList cityBox">
      <ul>
        <li>请选选择身份</li>
      </ul>
    </div>
  </main>
</form>
<script>
  $(function () {
    FastClick.attach(document.body)
  })
  const relaceUrl = 'https://a.139lc.com/v1/services/SoapService/'
  const codeUrl = 'https://m.139lc.com:21900/api/trade/yzmhq'
  const testUrl = 'http://118.89.36.194:18487/Inter/services/SoapService/doService'
  const appSignUrl = 'https://a.139lc.com/v1/w/appSignCard.htm' //签约地址
  const appAuthUrl = 'https://a.139lc.com/v1/w/authConfig.htm'    //授权地址
</script>
<script>
  $('#checkBank').on('click', function (e) {
    let postData = getPostData('{"service":"A1705003","dataType":"json","OPERATION_PLATFORM":"2"}')
    doRequest(relaceUrl, postData, function (data) {
      let code = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_MSG_HDR.MSG_CODE
      let msg = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_MSG_HDR.MSG_TEXT
      if (code !== "0") {
        xw.error(msg, xw.loadRemove())
        return false
      }
      let obj = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_COMM_DATA[0]
      if (obj && obj.length > 0) {
        let html = '<ul>';
        obj.map(item => {
          if (item.YMBM.length == 4) {
            html += '<li data="' + item.YHMC + '" data-id="' + item.YMBM + '">' +
              item.YHMC +
              '</li>'
          }
        });
        html += '</ul>';
        $('.bankBox').html(html)
      }
      $('.bankBox').addClass('active');
      $('.container').removeClass('active')
      xw.loadRemove()
    })
  });

  $('.boxList.bankBox').on('click', 'li', function (e) {
    let data = $(e.currentTarget).attr('data')
    let data_id = $(e.currentTarget).attr('data-id')
    if (data) {
      $('.bankBox').removeClass('active')
      $('.container').addClass('active')
      $('#bankValue').val(data).attr('data-id', data_id)
    }
  })
</script>
<script>
  $('#checkProvince').on('click', function (e) {
    let postData = getPostData('{"service":"A1705001","dataType":"json"}')
    doRequest(relaceUrl, postData, function (data) {
      let code = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_MSG_HDR.MSG_CODE
      let msg = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_MSG_HDR.MSG_TEXT
      if (code !== "0") {
        xw.error(msg, xw.loadRemove())
        return false
      }
      let obj = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_COMM_DATA[0]
      if (obj && obj.length > 0) {
        let html = '<ul>'
        obj.map(item => {
          html += '<li data="' + item.SSMC + '" data-id="' + item.SSDM + '">' +
            item.SSMC +
            '</li>'
        })
        html += '</ul>'
        $('.provinceBox').html(html)
      }
      $('.provinceBox').addClass('active')
      $('.container').removeClass('active')
      xw.loadRemove()
    })
  })

  $('.boxList.provinceBox').on('click', 'li', function (e) {
    let data = $(e.currentTarget).attr('data')
    let data_id = $(e.currentTarget).attr('data-id')
    if (data) {
      $('.provinceBox').removeClass('active')
      $('.container').addClass('active')
      $('#provinceValue').val(data).attr('data-id', data_id)
      $('#cityValue').val('')
    }
  })
</script>
<script>
  $('#checkCity').on('click', function (e) {
    let pid = $('#provinceValue').attr('data-id')
    if (!pid) {
      xw.warn('请先选择省份')
      return false;
    }
    let postData = getPostData('{"service":"A1705002","dataType":"json","PAR_REGION_ID":"' + pid + '"}')
    doRequest(relaceUrl, postData, function (data) {
      let code = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_MSG_HDR.MSG_CODE
      let msg = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_MSG_HDR.MSG_TEXT
      if (code !== "0") {
        xw.error(msg, xw.loadRemove())
        return false
      }
      let obj = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_COMM_DATA[0]
      if (obj && obj.length > 0) {
        let html = '<ul>'
        obj.map(item => {
          html += '<li data="' + item.DQMC + '" data-id="' + item.DQDM + '">' +
            item.DQMC +
            '</li>'
        })
        html += '</ul>'
        $('.cityBox').html(html)
      }
      $('.cityBox').addClass('active')
      $('.container').removeClass('active')
      xw.loadRemove()
    })
  })

  $('.boxList.cityBox').on('click', 'li', function (e) {
    var data = $(e.currentTarget).attr('data')
    let data_id = $(e.currentTarget).attr('data-id')
    if (data) {
      $('.cityBox').removeClass('active')
      $('.container').addClass('active')
      $('#cityValue').val(data).attr('data-id', data_id)
    }
  })
</script>
<script>
  function sendCode(e) {
    if ($.cxValidation($('#phone'))) {
      let phone = $('#phone').val()
      let postData = JSON.stringify({"sjhm": phone})
      $.post(codeUrl, postData, function () {
        let time = 60
        e.attr('disabled', true).addClass('disabled')
        let timeId = setInterval(function () {
          e.text(time + 's后重新发送')
          time--
          if (time === 0) {
            window.clearInterval(timeId)
            e.attr('disabled', false).removeClass('disabled')
            e.text('发送验证码')
          }
        }, 1000)
      })
      // doRequest(codeUrl, postData, function (data) {
      //   console.log('send code api=====>');
      //   console.log(data);
      //   let code = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_MSG_HDR.MSG_CODE
      //   let msg = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_MSG_HDR.MSG_TEXT
      //   if (code !== "0") {
      //     xw.error(msg, xw.loadRemove())
      //     return false
      //   }
      //   let time = 60
      //   e.attr('disabled', true).addClass('disabled')
      //   let timeId = setInterval(function () {
      //     e.text(time + '后重新发送')
      //     time--
      //     if (time === 0) {
      //       window.clearInterval(timeId)
      //       e.text('发送验证码')
      //     }
      //   }, 1000)
      // })
    }
  }
</script>
<script>
  $(function () {

    $.cxValidation.attach($('#regForm'))
    $("form").submit(function (e) {
      e.preventDefault()
      if ($.cxValidation($('#regForm'))) {
        console.log('check success')
        let phone = $('#phone').val()
        let password = $('#password').val()
        let checkCode = $('#checkCode').val()
        let realName = $('#realName').val()
        let idCode = $('#idCode').val()
        let bankValue = $('#bankValue').attr('data-id')
        let bankNo = $('#bankNo').val()
        let provinceValue = $('#provinceValue').attr('data-id')
        let cityValue = $('#cityValue').attr('data-id')
        let cgPwd = $('#cgPwd').val()
        let ccgPwd = $('#ccgPwd').val()

        let postData = getPostData('{"service":"FR100100","dataType":"json",' +
          '"khxm":"' + realName + '","khsfzhm":"' + idCode + '","dlzh":"' + phone + '","jymm":"' + cgPwd + '","khyhm":"' + bankValue + '",' +
          '"khkh":"' + bankNo + '","khdqm":"' + cityValue + '","IS_THIRD":"2","yzm":"' + checkCode + '","USER_NAME":"' + phone + '","USER_PWD":"' + password + '",' +
          '"REG_FROM":"0"}')
        doRequest(relaceUrl, postData, function (data) {
          console.log(data);
          let code = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_MSG_HDR.MSG_CODE
          let msg = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_MSG_HDR.MSG_TEXT
          let resData = JSON.parse($(data).find('return').html().toString())['ANSWERS'][0].ANS_COMM_DATA
          if (code !== "0") {
            xw.error(msg, xw.loadRemove())
            return false
          } else {
            //url + "?login_id=" + dlzh + "&mobile=" + dlzh + "&back_url=" + back_url + "&from_plat=1";
            window.localStorage.setItem('登录状态标识', '1')
            window.localStorage.setItem('登录账号', phone)
            window.localStorage.setItem('我的交易账号', resData[0][0].JYZH)

            let jumpUrl = appSignUrl + '?login_id=' + phone + '&mobile=' + phone + '&back_url=https://m.139lc.com/views/wd/home/home.html&from_plat=WEB'
            window.location.href = jumpUrl
            console.log(jumpUrl);
            xw.success('操作成功', xw.loadRemove())
          }
        })
      }
    })
  })
</script>
<script>
  function getPostData(paramJson) {
    // console.log(paramJson);
    var postData;
    // var param = JSON.parse(paramJson);
    // param.random=Math.random();
    // var newParams = JSON.stringify(param);
    // console.log(param);
    postData = '<?xml version="1.0" encoding="utf-8"?>';
    postData += '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:Soapservice="http://soap.centms.com/" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">';
    postData += '<soap:Body>';
    postData += '<Soapservice:doService>';
    postData += '<requestXml>';
    postData += '{"REQUESTS":[{"REQ_COMM_DATA":';
    postData += paramJson;
    postData += '}]}';
    postData += '</requestXml>';
    postData += '</Soapservice:doService>';
    postData += '</soap:Body>';
    postData += '</soap:Envelope>';
    return postData;
  }

  function doRequest(url, data, successFn) {
    $.ajax({
      type: "POST",
      url: url,
      data: data,
      timeout: 60 * 1000,
      ContentType: "text/xml;charset=UTF-8",
      dataType: "XML",
      async: true,
      cache: false,
      // crossDomain:true,
      beforeSend: function () {
        xw.load('数据请求中')
      },
      success: successFn,
      error: function (e) {
        xw.error('请求失败', xw.loadRemove())
      },
      complete: function () {
        console.log('full');
      }
    })
  }
</script>
</body>
</html>